<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Blog</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="./css/edit-blog.css">
</head>

<body>
    <div class="navbar">
        <div class="navbar-title">Personal Pursuits</div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="index.html" id="logoutBtn" class="btn">Logout</a>
        </div>
    </div>
    <div class="card">
        <h2 class="card-title">Edit Blog</h2>
        <form id="editBlogForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">Blog Title</label>
                <input type="text" id="title" name="title" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="content">Content</label>
                <textarea id="content" name="content" class="form-control" rows="5" required></textarea>
            </div>
            <div class="form-group">
                <label for="fileInput">Upload Images</label>
                <input type="file" id="fileInput" name="files" class="form-control-file" multiple>
            </div>
            <div id="imagePreviewContainer" class="image-preview"></div>
            <button type="submit" class="btn btn-primary">Update Blog</button>
        </form>
        <div id="message" class="alert"></div>
    </div>

    <script>

        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn.addEventListener('click', function (e) {
            e.preventDefault(); // Prevent the default link behavior

            // Remove the authentication token from localStorage
            localStorage.removeItem('jwt');

            // Optionally, you can redirect the user to the login page or home page
            window.location.href = 'index.html';
        });

        const urlParams = new URLSearchParams(window.location.search);
        const blogId = urlParams.get('id');
        const jwtToken = localStorage.getItem('jwt');

        // Fetch and populate the blog data in the form
        if (blogId) {
            fetch(`http://localhost:8080/post/id/${blogId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('title').value = data.title;
                    document.getElementById('content').value = data.content;
                    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                    imagePreviewContainer.innerHTML = '';
                    if (data.imageUrls) {
                        data.imageUrls.forEach(url => {
                            // Create a container for the image and delete button
                            const imageContainer = document.createElement('div');
                            imageContainer.className = 'image-container';

                            const img = document.createElement('img');
                            img.src = url;
                            imageContainer.appendChild(img);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete Image';
                            deleteButton.className = 'btn btn-danger btn-sm';
                            deleteButton.onclick = (event) => {
                                event.preventDefault(); // Prevent any default action
                                deleteImage(url, imageContainer);
                            };
                            imageContainer.appendChild(deleteButton);

                            imagePreviewContainer.appendChild(imageContainer);
                        });
                    }
                })
                .catch(error => {
                    document.getElementById('message').innerText = 'Error fetching blog: ' + error.message;
                    document.getElementById('message').className = 'alert alert-danger';
                });
        } else {
            document.getElementById('message').innerText = 'Invalid blog ID.';
            document.getElementById('message').className = 'alert alert-danger';
        }

        // Handle form submission
        document.getElementById('editBlogForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(this);
            fetch(`http://localhost:8080/post/id/${blogId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text); });
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('message').innerText = 'Blog updated successfully!';
                    document.getElementById('message').className = 'alert alert-success';
                    // Redirect to the view blog page only after successful update
                    setTimeout(() => {
                        window.location.href = `view-blog.html?id=${encodeURIComponent(blogId)}`;
                    }, 1000); // Optional delay to show the success message
                })
                .catch(error => {
                    document.getElementById('message').innerText = 'Error: ' + error.message;
                    document.getElementById('message').className = 'alert alert-danger';
                });
        });

        function deleteImage(imageUrl, imageContainer) {
            fetch('http://localhost:8080/post/delete-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify({ imageUrl })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete image');
                    }
                    // Remove the image container from the frontend
                    imageContainer.parentNode.removeChild(imageContainer);
                })
                .catch(error => {
                    console.error('Error deleting image:', error);
                });
        }
    </script>

    <!-- <script>
    const urlParams = new URLSearchParams(window.location.search);
    const blogId = urlParams.get('id');
    const jwtToken = localStorage.getItem('jwt');

    // Fetch and populate the blog data in the form
    if (blogId) {
        fetch(`http://localhost:8080/post/id/${blogId}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + jwtToken
            }
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('title').value = data.title;
                document.getElementById('content').value = data.content;
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                imagePreviewContainer.innerHTML = '';
                if (data.imageUrls) {
                    data.imageUrls.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        imagePreviewContainer.appendChild(img);
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete Image';
                        deleteButton.className = 'btn btn-danger btn-sm';
                        deleteButton.onclick = (event) => {
                            event.preventDefault(); // Prevent any default action
                            deleteImage(url);
                        };
                        imagePreviewContainer.appendChild(deleteButton);
                    });
                }
            })
            .catch(error => {
                document.getElementById('message').innerText = 'Error fetching blog: ' + error.message;
                document.getElementById('message').className = 'alert alert-danger';
            });
    } else {
        document.getElementById('message').innerText = 'Invalid blog ID.';
        document.getElementById('message').className = 'alert alert-danger';
    }

    // Handle form submission
    document.getElementById('editBlogForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        fetch(`http://localhost:8080/post/id/${blogId}`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + jwtToken
            },
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('message').innerText = 'Blog updated successfully!';
                document.getElementById('message').className = 'alert alert-success';
                // Redirect to the view blog page only after successful update
                setTimeout(() => {
                    window.location.href = `view-blog.html?id=${encodeURIComponent(blogId)}`;
                }, 1000); // Optional delay to show the success message
            })
            .catch(error => {
                document.getElementById('message').innerText = 'Error: ' + error.message;
                document.getElementById('message').className = 'alert alert-danger';
            });
    });

    function deleteImage(imageUrl) {
        fetch('http://localhost:8080/post/delete-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify({ imageUrl })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete image');
                }
                // Remove the image preview from the frontend
                const img = document.querySelector(`img[src='${imageUrl}']`);
                img.parentNode.removeChild(img);
                const button = img.nextSibling;
                button.parentNode.removeChild(button);
            })
            .catch(error => {
                console.error('Error deleting image:', error);
            });
    }
</script> -->


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
<!-- 

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const blogId = urlParams.get('id');
        const jwtToken = localStorage.getItem('jwt');

        // Fetch and populate the blog data in the form
        if (blogId) {
            fetch(`http://localhost:8080/post/id/${blogId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('title').value = data.title;
                    document.getElementById('content').value = data.content;
                    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                    imagePreviewContainer.innerHTML = '';
                    if (data.imageUrls) {
                        data.imageUrls.forEach(url => {
                            const img = document.createElement('img');
                            img.src = url;
                            imagePreviewContainer.appendChild(img);
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete Image';
                            deleteButton.className = 'btn btn-danger btn-sm';
                            deleteButton.onclick = () => deleteImage(url);
                            imagePreviewContainer.appendChild(deleteButton);
                        });
                    }
                })
                .catch(error => {
                    document.getElementById('message').innerText = 'Error fetching blog: ' + error.message;
                    document.getElementById('message').className = 'alert alert-danger';
                });
        } else {
            document.getElementById('message').innerText = 'Invalid blog ID.';
            document.getElementById('message').className = 'alert alert-danger';
        }

        // Handle form submission
        document.getElementById('editBlogForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(this);
            fetch(`http://localhost:8080/bloggiator/id/${blogId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text); });
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('message').innerText = 'Blog updated successfully!';
                    document.getElementById('message').className = 'alert alert-success';
                    // Redirect to the view blog page only after successful update
                    setTimeout(() => {
                        window.location.href = `view-blog.html?id=${encodeURIComponent(blogId)}`;
                    }, 1000); // Optional delay to show the success message
                })
                .catch(error => {
                    document.getElementById('message').innerText = 'Error: ' + error.message;
                    document.getElementById('message').className = 'alert alert-danger';
                });
        });

        function deleteImage(imageUrl) {
            fetch('http://localhost:8080/bloggiator/delete-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify({ imageUrl })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete image');
                    }
                    // Remove the image preview from the frontend
                    const img = document.querySelector(`img[src='${imageUrl}']`);
                    img.parentNode.removeChild(img);
                    const button = img.nextSibling;
                    button.parentNode.removeChild(button);
                })
                .catch(error => {
                    console.error('Error deleting image:', error);
                });
        }
    </script>

-->